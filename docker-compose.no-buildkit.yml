# Docker Compose with BuildKit disabled
# Use this if you experience timeout issues with the regular docker-compose.yml

# To use this file, run:
# docker-compose -f docker-compose.no-buildkit.yml up --build

# ============================================
# DOCKER COMPOSE CONFIGURATION
# ============================================
# This file orchestrates the Backend and Frontend services
# with BuildKit disabled for better compatibility

services:
  # ============================================
  # BACKEND SERVICE (Spring Boot + H2 Database)
  # ============================================
  backend:
    # Build the backend using the Dockerfile in ./backend directory
    build:
      context: ./backend
      dockerfile: Dockerfile

    # Container name for easy identification
    container_name: bangla-lms-backend

    # Map port 8080 on the host to port 8080 in the container
    # Access the backend at: http://localhost:8080
    ports:
      - "8080:8080"

    # Environment variables for Spring Boot
    environment:
      # Use file-based H2 database for data persistence
      - SPRING_DATASOURCE_URL=jdbc:h2:file:/data/lmsdb
      - SPRING_DATASOURCE_DRIVER_CLASS_NAME=org.h2.Driver
      - SPRING_H2_CONSOLE_ENABLED=true
      - JWT_SECRET=BanglaLearningLMS2024SecretKeyForJWTAuthenticationMinimum256BitsRequired
      - JWT_EXPIRATION=86400000

    # Volume for data persistence (H2 database file)
    volumes:
      - ./data:/data

    # Wait for backend to be healthy before starting dependent services
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================
  # FRONTEND SERVICE (React + Nginx)
  # ============================================
  frontend:
    # Build the frontend using the Dockerfile in the root directory
    build:
      context: .
      dockerfile: Dockerfile

    # Container name for easy identification
    container_name: bangla-lms-frontend

    # Map port 3000 on the host to port 80 in the container
    # Access the frontend at: http://localhost:3000
    ports:
      - "3000:80"

    # Wait for backend before starting frontend
    depends_on:
      backend:
        condition: service_healthy

    # Environment variables for frontend build
    environment:
      - VITE_BACKEND_URL=http://localhost:8080

# ============================================
# VOLUMES
# ============================================
volumes:
  # Volume for data persistence
  data:
    driver: local
